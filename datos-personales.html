<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datos Personales - Cuarzo Empresarial</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background-color: #000000; color: #FFFFFF; font-family: 'Montserrat', sans-serif; margin: 0; padding: 30px; }
        .container { max-width: 900px; margin: auto; background-color: #0d0d0d; padding: 30px; border-radius: 10px; box-shadow: 0 0 40px rgba(255, 255, 255, 0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333333; padding-bottom: 15px; }
        .header h1 { font-size: 2em; margin: 0; }
        .card { background-color: #1a1a1a; padding: 25px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #222; }
        .card h2 { margin-top: 0; font-size: 1.5em; border-bottom: 1px solid #333333; padding-bottom: 10px; margin-bottom: 20px; }
        
        /* Estilos para la Foto de Perfil */
        .profile-photo-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; gap: 15px; }
        .photo-preview-container { width: 150px; height: 150px; border-radius: 50%; border: 3px solid #FFFFFF; overflow: hidden; background-color: #333; display: flex; justify-content: center; align-items: center; position: relative; cursor: pointer; transition: transform 0.2s; }
        .photo-preview-container:hover { transform: scale(1.03); }
        .photo-preview-container img { width: 100%; height: 100%; object-fit: cover; }
        .photo-preview-container i { font-size: 4em; color: #666; }
        
        .upload-btn { background-color: transparent; border: 1px solid #FFFFFF; color: #FFFFFF; padding: 8px 20px; border-radius: 20px; font-size: 0.9em; cursor: pointer; transition: 0.3s; font-weight: 600; }
        .upload-btn:hover { background-color: #FFFFFF; color: #000000; }
        .upload-hint { font-size: 0.8em; color: #aaa; text-align: center; margin-top: -5px; }
        #file-input { display: none; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #cccccc; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #333; border-radius: 4px; background-color: #2a2a2a; color: #FFFFFF; box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
        .date-age-group { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
        .form-button { padding: 15px 30px; background-color: #FFFFFF; color: #000000; border: none; border-radius: 5px; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 20px; width: 100%; text-transform: uppercase; }
        .form-button:hover { background-color: #cccccc; }
        .back-link { text-decoration: none; color: #CCCCCC; }
        
        #loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <i class="fas fa-spinner fa-spin fa-3x"></i>
        <p style="margin-top: 15px;">Guardando cambios...</p>
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-user-circle"></i> Datos Personales</h1>
            <a href="workspace.html" class="back-link"><i class="fas fa-arrow-left"></i> Volver al Panel</a>
        </div>

        <form id="profile-form">
            
            <!-- SECCIÓN DE FOTO DE PERFIL -->
            <div class="card">
                <h2>Foto de Perfil</h2>
                <div class="profile-photo-section">
                    <div class="photo-preview-container" onclick="document.getElementById('file-input').click()">
                        <img id="photo-preview" src="" style="display:none;">
                        <i id="photo-placeholder" class="fas fa-camera"></i>
                    </div>
                    <input type="file" id="file-input" accept="image/*">
                    <button type="button" class="upload-btn" onclick="document.getElementById('file-input').click()">
                        <i class="fas fa-search"></i> Examinar Archivos
                    </button>
                    <p class="upload-hint">Formatos: JPG o PNG. Tamaño máximo recomendado: 2MB.</p>
                </div>
            </div>

            <div class="card">
                <h2>Información General y Contacto</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="nombre">Nombre Completo</label>
                        <input type="text" id="nombre" required>
                    </div>
                    <div class="input-group">
                        <label>Fecha de Nacimiento y Edad</label>
                        <div class="date-age-group">
                            <input type="date" id="fechaNacimiento" onchange="calcularEdad()" required>
                            <input type="text" id="edad" placeholder="Edad" readonly style="background-color: #333333;">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="nacionalidad">Nacionalidad</label>
                        <select id="nacionalidad" required>
                            <option value="">-- Seleccione --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="estadoCivil">Estado Civil</label>
                        <select id="estadoCivil">
                            <option value="soltero">Soltero/a</option>
                            <option value="casado">Casado/a</option>
                            <option value="divorciado">Divorciado/a</option>
                            <option value="viudo">Viudo/a</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="emailContacto">Email de Contacto</label>
                        <input type="email" id="emailContacto" required>
                    </div>
                    <div class="input-group">
                        <label for="telefono">Teléfono / WhatsApp</label>
                        <input type="tel" id="telefono" required placeholder="+54 9...">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Residencia y Ubicación</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="pais">País de Residencia</label>
                        <select id="pais" required>
                            <option value="">-- Seleccione País --</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="estado">Estado / Provincia / Ciudad</label>
                        <input type="text" id="estado" placeholder="Ciudad o Estado" required>
                    </div>
                    <div class="input-group">
                        <label for="domicilio">Domicilio Real</label>
                        <input type="text" id="domicilio" placeholder="Calle, Número, Depto">
                    </div>
                    <div class="input-group">
                        <label for="paisFiscal">País de Residencia Fiscal</label>
                        <select id="paisFiscal" required>
                            <option value="">-- Seleccione País Fiscal --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Identificación y Cobro</h2>
                <div class="form-grid">
                    <div class="input-group">
                        <label for="tipoDocumento">Tipo de Identificación</label>
                        <select id="tipoDocumento" required>
                            <option value="DNI">DNI</option>
                            <option value="CI">Cédula de Identidad</option>
                            <option value="PASAPORTE">Pasaporte</option>
                            <option value="MIGRATORIO">Certificado Migratorio</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="numeroDocumento">Número de ID</label>
                        <input type="text" id="numeroDocumento" required>
                    </div>
                    <div class="input-group">
                        <label for="cuit">CUIT / CUIL / Tax ID</label>
                        <input type="text" id="cuit" required>
                    </div>
                    <div class="input-group">
                        <label for="metodoPago">Medio de Pago</label>
                        <select id="metodoPago" required>
                            <option value="PayPal">PayPal</option>
                            <option value="Mercado Pago">Mercado Pago</option>
                            <option value="Banco">Transferencia Bancaria</option>
                            <option value="Prex">Prex</option>
                        </select>
                    </div>
                    <div class="input-group" style="grid-column: 1 / -1;">
                        <label for="datoPago">Dato de Cobro (CBU, Alias o Email)</label>
                        <input type="text" id="datoPago" required>
                    </div>
                </div>
            </div>

            <button type="submit" class="form-button" id="btn-submit">
                <i class="fas fa-save"></i> Guardar Todo en Base de Datos
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId;
        let fotoBase64 = "";

        const paisesMundo = ["Afganistán", "Albania", "Alemania", "Andorra", "Angola", "Antigua y Barbuda", "Arabia Saudita", "Argelia", "Argentina", "Armenia", "Australia", "Austria", "Azerbaiyán", "Bahamas", "Bangladés", "Barbados", "Baréin", "Bélgica", "Belice", "Benín", "Bielorrusia", "Bolivia", "Bosnia y Herzegovina", "Botsuana", "Brasil", "Brunéi", "Bulgaria", "Burkina Faso", "Burundi", "Bután", "Cabo Verde", "Camboya", "Camerún", "Canadá", "Catar", "Chad", "Chile", "China", "Chipre", "Colombia", "Comoras", "Corea del Norte", "Corea del Sur", "Costa de Marfil", "Costa Rica", "Croacia", "Cuba", "Dinamarca", "Dominica", "Ecuador", "Egipto", "El Salvador", "Emiratos Árabes Unidos", "Eritrea", "Eslovaquia", "Eslovenia", "España", "Estados Unidos", "Estonia", "Etiopía", "Filipinas", "Finlandia", "Fiyi", "Francia", "Gabón", "Gambia", "Georgia", "Ghana", "Granada", "Grecia", "Guatemala", "Guyana", "Guinea", "Haití", "Honduras", "Hungría", "India", "Indonesia", "Irak", "Irán", "Irlanda", "Islandia", "Islas Marshall", "Islas Salomón", "Israel", "Italia", "Jamaica", "Japón", "Jordania", "Kazajistán", "Kenia", "Kiribati", "Kuwait", "Laos", "Lesoto", "Letonia", "Líbano", "Liberia", "Libia", "Liechtenstein", "Lituania", "Luxemburgo", "Macedonia del Norte", "Madagascar", "Malasia", "Malaui", "Maldivas", "Malí", "Malta", "Marruecos", "Mauricio", "Mauritania", "México", "Micronesia", "Moldavia", "Mónaco", "Mongolia", "Montenegro", "Mozambique", "Namibia", "Nauru", "Nepal", "Nicaragua", "Níger", "Nigeria", "Noruega", "Nueva Zelanda", "Omán", "Países Bajos", "Pakistán", "Palaos", "Panamá", "Papúa Nueva Guinea", "Paraguay", "Perú", "Polonia", "Portugal", "Reino Unido", "República Centroafricana", "República Checa", "República Dominicana", "Ruanda", "Rumania", "Rusia", "Samoa", "San Marino", "Senegal", "Serbia", "Seychelles", "Sierra Leona", "Singapur", "Siria", "Somalia", "Sri Lanka", "Sudáfrica", "Sudán", "Suecia", "Suiza", "Surinam", "Tailandia", "Tanzania", "Tayikistán", "Togo", "Trinidad y Tobago", "Túnez", "Turquía", "Ucrania", "Uganda", "Uruguay", "Uzbekistán", "Vanuatu", "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabue"];
        const nacionalidades = ["Afgana", "Albanesa", "Alemana", "Americana", "Andorrana", "Angoleña", "Argentina", "Australiana", "Austriaca", "Belga", "Boliviana", "Brasileña", "Canadiense", "Chilena", "China", "Colombiana", "Coreana", "Costarricense", "Cubana", "Danesa", "Ecuatoriana", "Egipcia", "Española", "Finlandesa", "Francesa", "Griega", "Guatemalteca", "Hondureña", "Húngara", "India", "Indonesa", "Iraní", "Irlandesa", "Israelí", "Italiana", "Japonesa", "Mexicana", "Noruega", "Panameña", "Paraguaya", "Peruana", "Polaca", "Portuguesa", "Rusa", "Salvadoreña", "Sueca", "Suiza", "Uruguaya", "Venezolana"];

        window.onload = () => {
            const selP = document.getElementById('pais');
            const selF = document.getElementById('paisFiscal');
            const selN = document.getElementById('nacionalidad');
            paisesMundo.sort().forEach(p => {
                selP.add(new Option(p, p));
                selF.add(new Option(p, p));
            });
            nacionalidades.sort().forEach(n => selN.add(new Option(n, n)));
        };

        // Procesar archivo de imagen
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) {
                    alert("La imagen excede los 2MB. Por favor, elige una más pequeña.");
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(event) {
                    fotoBase64 = event.target.result;
                    document.getElementById('photo-preview').src = fotoBase64;
                    document.getElementById('photo-preview').style.display = 'block';
                    document.getElementById('photo-placeholder').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                const snap = await getDoc(doc(db, "colaboradores", userId));
                if (snap.exists()) {
                    const d = snap.data();
                    
                    if (d.fotoPerfil) {
                        fotoBase64 = d.fotoPerfil;
                        document.getElementById('photo-preview').src = fotoBase64;
                        document.getElementById('photo-preview').style.display = 'block';
                        document.getElementById('photo-placeholder').style.display = 'none';
                    }

                    document.getElementById('nombre').value = d.nombre || "";
                    document.getElementById('emailContacto').value = d.emailContacto || user.email;
                    document.getElementById('telefono').value = d.telefono || "";
                    document.getElementById('fechaNacimiento').value = d.fechaNacimiento || "";
                    document.getElementById('nacionalidad').value = d.nacionalidad || "";
                    document.getElementById('estadoCivil').value = d.estadoCivil || "soltero";
                    document.getElementById('pais').value = d.pais || "";
                    document.getElementById('estado').value = d.estado || "";
                    document.getElementById('domicilio').value = d.domicilio || "";
                    document.getElementById('paisFiscal').value = d.paisFiscal || "";
                    document.getElementById('tipoDocumento').value = d.tipoDocumento || "";
                    document.getElementById('numeroDocumento').value = d.numeroDocumento || "";
                    document.getElementById('cuit').value = d.cuit || "";
                    document.getElementById('metodoPago').value = d.metodoPago || "";
                    document.getElementById('datoPago').value = d.datoPago || "";
                    calcularEdad();
                }
            } else { window.location.href = "login.html"; }
        });

        window.calcularEdad = () => {
            const f = document.getElementById('fechaNacimiento').value;
            if (!f) return;
            const hoy = new Date();
            const nac = new Date(f);
            let edad = hoy.getFullYear() - nac.getFullYear();
            if (hoy.getMonth() < nac.getMonth() || (hoy.getMonth() === nac.getMonth() && hoy.getDate() < nac.getDate())) edad--;
            document.getElementById('edad').value = edad + " años";
        };

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loading-overlay').style.display = 'flex';
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;

            const datosParaGuardar = {
                fotoPerfil: fotoBase64,
                nombre: document.getElementById('nombre').value,
                emailContacto: document.getElementById('emailContacto').value,
                telefono: document.getElementById('telefono').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                nacionalidad: document.getElementById('nacionalidad').value,
                estadoCivil: document.getElementById('estadoCivil').value,
                pais: document.getElementById('pais').value,
                estado: document.getElementById('estado').value,
                domicilio: document.getElementById('domicilio').value,
                paisFiscal: document.getElementById('paisFiscal').value,
                tipoDocumento: document.getElementById('tipoDocumento').value,
                numeroDocumento: document.getElementById('numeroDocumento').value,
                cuit: document.getElementById('cuit').value,
                metodoPago: document.getElementById('metodoPago').value,
                datoPago: document.getElementById('datoPago').value,
                ultimaActualizacion: new Date()
            };

            try {
                await updateDoc(doc(db, "colaboradores", userId), datosParaGuardar);
                alert("Datos guardados con éxito.");
                window.location.href = "workspace.html";
            } catch (err) {
                alert("Error al guardar: " + err.message);
                btn.disabled = false;
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });
    </script>
</body>
</html>