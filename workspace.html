<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspace | Cuarzo Empresarial</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root { 
            --primary: #FFFFFF; 
            --bg: #000000; 
            --card: #0d0d0d; 
            --accent: #FFFFFF; 
            --border: #333; 
            --gray-soft: #b3b3b3;
            --sidebar-width: 280px;
        }
        
        body {
            background-color: var(--bg); color: var(--primary);
            font-family: 'Montserrat', sans-serif; margin: 0; padding: 0;
            display: flex; min-height: 100vh; overflow-x: hidden;
        }

        /* --- SIDEBAR INTELIGENTE --- */
        .sidebar {
            width: var(--sidebar-width); background-color: var(--card); padding: 25px 20px;
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.9);
            display: flex; flex-direction: column; position: fixed;
            height: 100vh; z-index: 2000; 
            left: calc(var(--sidebar-width) * -1); 
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            border-right: 1px solid var(--border);
            box-sizing: border-box;
        }
        
        .sidebar.open { transform: translateX(var(--sidebar-width)); }

        .sidebar-header { 
            text-align: center; 
            margin-bottom: 35px; 
            padding: 10px;
        }
        
        /* Ajuste del Logo de la Empresa */
        .company-logo {
            width: 140px; 
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.1));
        }
        
        .sidebar nav a {
            display: flex; align-items: center; color: var(--gray-soft); text-decoration: none;
            padding: 14px 15px; margin-bottom: 6px; border-radius: 10px;
            transition: 0.3s all; font-weight: 600; font-size: 0.85em;
        }
        .sidebar nav a:hover { background-color: #151515; color: #FFFFFF; transform: translateX(5px); }
        .sidebar nav a i { margin-right: 15px; width: 25px; text-align: center; font-size: 1.1em; }
        .sidebar nav a.active { background-color: #FFF; color: #000; }
        
        .nav-tools { border: 1px dashed #444 !important; margin-top: 10px; color: #fff !important; }
        .nav-tools:hover { border-style: solid; background: #fff !important; color: #000 !important; }

        /* --- CONTENIDO --- */
        .main-content { flex-grow: 1; width: 100%; display: flex; flex-direction: column; }

        .top-bar {
            background: rgba(0,0,0,0.95); padding: 15px 30px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px);
        }

        .menu-trigger {
            background: #FFF; color: #000; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: 800; font-size: 0.7rem;
            display: flex; align-items: center; gap: 10px; text-transform: uppercase; letter-spacing: 1px;
        }

        .user-badge {
            display: flex; align-items: center; gap: 12px;
            background: #111; padding: 6px 16px; border-radius: 50px;
            border: 1px solid var(--border);
        }

        .user-name-small { font-size: 0.75rem; font-weight: 700; color: #FFF; text-transform: uppercase; }

        .photo-circle {
            width: 32px; height: 32px; border-radius: 50%;
            background: #222; display: flex; align-items: center;
            justify-content: center; color: #FFF; border: 1px solid var(--border);
            overflow: hidden; background-size: cover; background-position: center;
        }

        /* --- DASHBOARD --- */
        .welcome-section { padding: 40px 50px 10px 50px; }
        .welcome-text {
            color: #FFFFFF; font-weight: 800; font-size: 2.2em;
            letter-spacing: -1px; margin: 0; text-transform: uppercase;
            border-left: 5px solid #FFFFFF; padding-left: 20px;
        }

        .content-body { padding: 0 50px 50px 50px; }

        .timer-card {
            background: var(--card); border: 1px solid var(--border); padding: 40px;
            border-radius: 20px; margin-bottom: 30px; text-align: center;
        }
        #timer-display { 
            font-size: 4rem; font-weight: 800; font-family: 'Courier New', monospace; 
            margin-bottom: 25px; color: #FFF;
        }

        .stats-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; margin-top: 25px;
        }
        .stat-card { 
            background: var(--card); padding: 30px; border-radius: 15px; 
            border: 1px solid var(--border);
        }
        .stat-card h3 { font-size: 0.65rem; color: #666; text-transform: uppercase; margin: 0; letter-spacing: 2px; }
        .stat-card p { font-size: 2em; font-weight: 800; margin: 10px 0 0; color: #FFFFFF; }

        .whatsapp-card {
            background: #080808; border: 1px solid #1a1a1a; padding: 30px; border-radius: 15px;
            margin-top: 40px; display: flex; align-items: center;
            justify-content: space-between; flex-wrap: wrap; gap: 20px;
        }
        .whatsapp-btn {
            background: #FFFFFF; color: #000000; padding: 12px 25px;
            border-radius: 8px; text-decoration: none; font-weight: 800;
            display: flex; align-items: center; gap: 10px; font-size: 0.8em;
        }

        .btn-action {
            border: none; padding: 15px 35px; border-radius: 8px; font-weight: 800; 
            cursor: pointer; transition: 0.3s; text-transform: uppercase; font-size: 0.8rem;
        }
        #btn-start { background: #FFFFFF; color: #000; }
        #btn-stop { background: #1a1a1a; color: #FFF; border: 1px solid #333; }

        .overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1500;
        }
        .overlay.active { display: block; }
    </style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="closeMenu()"></div>

    <div class="sidebar" id="sidebar" onmouseleave="closeMenu()">
        <div class="sidebar-header">
            <img src="logocuarzo.jpg" alt="Cuarzo Logo" class="company-logo">
            <h2 style="color:#FFF; font-size: 0.9rem; letter-spacing: 3px; font-weight: 800; margin: 0;">CUARZO</h2>
        </div>
        <nav>
            <a href="workspace.html" class="active"><i class="fas fa-home"></i> INICIO</a>
            <a href="herramientas.html" class="nav-tools"><i class="fas fa-tools"></i> HERRAMIENTAS</a>
            <a href="admin-control.html" id="btn-admin-link" style="display: none; background: #1a1a1a;">
                <i class="fas fa-user-shield"></i> PANEL MAESTRO
            </a>
            <a href="tareas-activas.html"><i class="fas fa-tasks"></i> TAREAS</a>
            <a href="reportes.html"><i class="fas fa-chart-line"></i> REPORTES</a>
            <a href="nuevos-clientes.html"><i class="fas fa-users"></i> CLIENTES</a>
            <a href="contrato-legal.html"><i class="fas fa-gavel"></i> LEGALES</a>
            <a href="datos-personales.html"><i class="fas fa-id-badge"></i> MI PERFIL</a>
            
            <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #222;">
                <a href="#" onclick="logout()" style="color: #555; font-size: 0.75em;">
                    <i class="fas fa-power-off"></i> CERRAR SESIÓN
                </a>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <header class="top-bar">
            <button class="menu-trigger" onclick="openMenu(event)">
                <i class="fas fa-bars"></i> Menú
            </button>
            <div class="user-badge">
                <span class="user-name-small" id="badge-name">...</span>
                <div class="photo-circle" id="user-photo-container">
                    <i class="fas fa-user" id="default-icon"></i>
                </div>
            </div>
        </header>

        <div class="welcome-section">
            <h1 class="welcome-text" id="welcome-msg">BIENVENIDO</h1>
        </div>

        <div class="content-body">
            <div class="timer-card">
                <h3 style="margin: 0 0 15px 0; font-size: 0.7rem; color: #555; letter-spacing: 3px; font-weight: 800;">TIEMPO DE TRABAJO</h3>
                <div id="timer-display">00:00:00</div>
                <div style="display: flex; justify-content: center; gap: 20px;">
                    <button id="btn-start" class="btn-action" onclick="startTimer()">Iniciar Turno</button>
                    <button id="btn-stop" class="btn-action" onclick="stopTimer()" disabled style="opacity:0.2;">Finalizar</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Proyectos</h3>
                    <p id="stat-proyectos">0</p>
                </div>
                <div class="stat-card">
                    <h3>Horas Totales</h3>
                    <p id="stat-horas">0.00</p>
                </div>
                <div class="stat-card">
                    <h3>Estado</h3>
                    <p id="stat-estado">-</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId, startTime, timerInterval;

        const SUPER_ADMINS = ["rrhhcuarzocristalempresarial@gmail.com", "hectormauricioraposso@gmail.com"];

        window.openMenu = (e) => {
            e.stopPropagation();
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        };

        window.closeMenu = () => {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        };

        // LÓGICA DE GÉNERO
        function obtenerSaludo(nombre) {
            if(!nombre) return "BIENVENIDO";
            const nom = nombre.trim().toLowerCase();
            const primer = nom.split(' ')[0];
            const esFem = primer.endsWith('a') || primer.endsWith('ina') || ["natalia", "guillermina", "lucia", "beatriz", "carmen"].includes(primer);
            return esFem ? "BIENVENIDA" : "BIENVENIDO";
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                onSnapshot(doc(db, "colaboradores", userId), (docSnap) => {
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        const nombre = d.nombre || 'USUARIO';
                        const saludo = obtenerSaludo(nombre);
                        
                        document.getElementById('welcome-msg').innerText = `${saludo}, ${nombre.toUpperCase()}`;
                        document.getElementById('badge-name').innerText = nombre.toUpperCase();
                        
                        if (d.fotoPerfil) {
                            document.getElementById('user-photo-container').style.backgroundImage = `url('${d.fotoPerfil}')`;
                            document.getElementById('default-icon').style.display = 'none';
                        }
                        if (SUPER_ADMINS.includes(user.email.toLowerCase()) || d.rol === "admin") {
                            document.getElementById('btn-admin-link').style.display = 'flex';
                        }
                        document.getElementById('stat-proyectos').innerText = d.proyectos_activos || 0;
                        document.getElementById('stat-horas').innerText = parseFloat(d.horas_totales || 0).toFixed(2);
                        document.getElementById('stat-estado').innerText = (d.estado || "ACTIVO").toUpperCase();
                    }
                });
            } else { window.location.href = "login.html"; }
        });

        window.startTimer = () => {
            startTime = Date.now();
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-start').style.opacity = "0.2";
            document.getElementById('btn-stop').disabled = false;
            document.getElementById('btn-stop').style.opacity = "1";
            timerInterval = setInterval(() => {
                const diff = Date.now() - startTime;
                let s = Math.floor(diff / 1000);
                let h = Math.floor(s / 3600), m = Math.floor((s % 3600) / 60);
                s = s % 60;
                document.getElementById('timer-display').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }, 1000);
        };

        window.stopTimer = async () => {
            if(!confirm("¿Registrar tiempo de jornada?")) return;
            clearInterval(timerInterval);
            const duration = (Date.now() - startTime) / 3600000;
            await updateDoc(doc(db, "colaboradores", userId), { horas_totales: increment(duration) });
            location.reload();
        };

        window.logout = async () => { signOut(auth).then(() => window.location.href = "login.html"); };
    </script>
</body>
</html>