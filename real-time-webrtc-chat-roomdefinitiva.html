<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuarzo Cristal | Workspace</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #000; --card: #0A0A0A; --primary: #FFF; --text-dim: #666; --border: #222; }
        body { background: var(--bg); color: var(--primary); font-family: 'Montserrat', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .container { 
            background: var(--card); 
            padding: 50px 40px; 
            border-radius: 2px; 
            width: 90%; 
            max-width: 420px; 
            border: 1px solid var(--border); 
            text-align: center;
            box-shadow: 0 40px 100px rgba(0,0,0,0.9);
        }

        h1 { font-weight: 800; letter-spacing: 6px; text-transform: uppercase; font-size: 1.1rem; margin-bottom: 5px; }
        .brand-sub { font-size: 0.55rem; color: var(--text-dim); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 30px; display: block; }

        .profile-box { margin-bottom: 30px; padding: 15px; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .user-name { font-weight: 400; font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; }

        /* Lista de Salas */
        .room-list-container { text-align: left; margin-top: 20px; }
        .list-title { font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 15px; display: block; text-align: center; }
        
        .room-item { 
            background: #050505; 
            border: 1px solid var(--border); 
            padding: 20px; 
            margin-bottom: 10px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px;
        }

        .room-info { display: flex; align-items: center; gap: 10px; font-size: 0.75rem; font-weight: 700; letter-spacing: 1px; }
        .dot-live { width: 8px; height: 8px; background: #FFF; border-radius: 50%; animation: blink 2s infinite; }

        /* Botones */
        .btn { width: 100%; padding: 16px; border: none; font-weight: 800; cursor: pointer; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 2px; transition: 0.4s; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--border); }
        .btn-outline:hover { border-color: var(--primary); }
        .btn-danger { background: transparent; color: #ff4444; border: 1px solid #331111; margin-top: 5px; font-size: 0.6rem; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        .empty-state { font-size: 0.65rem; color: #333; text-align: center; padding: 20px; border: 1px dashed #111; }
        .footer { margin-top: 40px; font-size: 0.5rem; color: #222; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>CUARZO CRISTAL</h1>
        <span class="brand-sub">Executive Workspace</span>

        <div class="profile-box">
            <div id="user-display" class="user-name">Sincronizando...</div>
        </div>

        <div class="room-list-container">
            <span class="list-title">Sesiones Disponibles</span>
            <div id="rooms-area">
                <div class="empty-state">Buscando sesiones activas...</div>
            </div>
        </div>

        <div id="admin-controls" style="display: none; margin-top: 30px;">
            <span class="list-title" style="margin-bottom: 10px;">Panel de Control</span>
            <button class="btn btn-outline" onclick="toggleRoom(true)">Crear Nueva Sesión</button>
        </div>

        <div class="footer">PROTECTED BY FIREBASE &bull; 2026</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, get } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d",
            databaseURL: "https://cuarzocristalempresarialsist-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        let finalUserName = "";
        let isAdmin = false;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Nombre limpio para Jitsi
                finalUserName = user.displayName ? user.displayName.toUpperCase() : user.email.split('@')[0].replace(/[0-9.]/g, ' ').trim().toUpperCase();
                document.getElementById('user-display').innerText = finalUserName;

                // Comprobar si el email está en la lista de administradores
                const adminsRef = ref(db, 'admins');
                const snapshot = await get(adminsRef);
                const adminsList = snapshot.val() || {};
                isAdmin = Object.values(adminsList).some(email => email.toLowerCase() === user.email.toLowerCase());

                if (isAdmin) {
                    document.getElementById('admin-controls').style.display = "block";
                }

                listenToRooms();
            } else {
                window.location.href = "login.html";
            }
        });

        function listenToRooms() {
            onValue(ref(db, 'sala_activa'), (snapshot) => {
                const data = snapshot.val();
                const area = document.getElementById('rooms-area');
                area.innerHTML = "";

                if (data && data.status === "online") {
                    area.innerHTML = `
                        <div class="room-item">
                            <div class="room-info">
                                <div class="dot-live"></div>
                                CAPACITACIÓN OFICIAL
                            </div>
                            <button class="btn btn-primary" onclick="joinMeeting()">Unirse Ahora</button>
                            ${isAdmin ? '<button class="btn btn-danger" onclick="toggleRoom(false)">Cerrar Sesión para Todos</button>' : ''}
                        </div>
                    `;
                } else {
                    area.innerHTML = `<div class="empty-state">No hay sesiones activas en este momento.</div>`;
                }
            });
        }

        window.toggleRoom = function(activate) {
            set(ref(db, 'sala_activa'), {
                status: activate ? "online" : "offline",
                host: finalUserName,
                timestamp: Date.now()
            }).then(() => {
                if(activate) joinMeeting();
            });
        }

        window.joinMeeting = function() {
            const roomName = "Capacitacion_Cuarzo_Oficial";
            const config = [
                'config.prejoinPageEnabled=true',
                'config.disableDeepLinking=true',
                `userInfo.displayName="${encodeURIComponent(finalUserName)}"`
            ].join('&');
            window.location.href = `https://meet.jit.si/${roomName}#${config}`;
        }
    </script>
</body>
</html>