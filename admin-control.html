<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Administrativo - Cuarzo Empresarial</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #000000;
            color: #FFFFFF;
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background-color: #0d0d0d; 
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #222;
            display: none; /* Se activa por JS */
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }
        .card {
            background-color: #1a1a1a; 
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #333;
        }
        .card h2 { color: #00FFFF; font-size: 1.2em; margin-top: 0; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: #888; font-size: 0.7em; text-transform: uppercase; border-bottom: 1px solid #333; }
        td { padding: 12px; border-bottom: 1px solid #222; font-size: 0.85em; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7em; font-weight: 800; }
        .badge-admin { background: #fff; color: #000; }
        .badge-user { background: #333; color: #fff; }

        .btn-action {
            padding: 6px 12px; background: #00FFFF; color: #000; border: none; 
            border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.7em;
        }
        
        #loading-screen { text-align: center; padding-top: 100px; }
        #error-screen { display: none; text-align: center; padding-top: 100px; color: #ff4444; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <i class="fas fa-spinner fa-spin" style="font-size: 3em; color: #00FFFF;"></i>
        <p>Verificando credenciales de dirección...</p>
    </div>

    <div id="error-screen">
        <i class="fas fa-exclamation-triangle" style="font-size: 3em;"></i>
        <h1>Acceso Denegado</h1>
        <p>Tu correo no tiene permisos de Súper Admin.</p>
        <a href="workspace.html" style="color: #00FFFF;">Volver al Inicio</a>
    </div>

    <div id="admin-content" class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> PANEL MAESTRO</h1>
            <a href="workspace.html" style="color: #888; text-decoration: none;">Cerrar</a>
        </div>

        <div class="card">
            <h2><i class="fas fa-users"></i> Control de Colaboradores</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Rol</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista-colab">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2><i class="fas fa-wallet"></i> Datos de Cobro Recientes</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Profesional</th>
                            <th>Método</th>
                            <th>Dato / CBU / Alias</th>
                        </tr>
                    </thead>
                    <tbody id="lista-pagos">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DIRECCIÓN AUTORIZADA (Héctor Mauricio corregido)
        const ADMINS_MAESTROS = [
            "rrhhcuarzocristalempresarial@gmail.com", 
            "hectormauricioraposso@gmail.com"
        ];

        onAuthStateChanged(auth, async (user) => {
            const loading = document.getElementById('loading-screen');
            const content = document.getElementById('admin-content');
            const error = document.getElementById('error-screen');

            if (user) {
                const userEmail = user.email.toLowerCase();
                
                // Verificamos si es uno de ustedes
                if (ADMINS_MAESTROS.includes(userEmail)) {
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    cargarDatos();
                } else {
                    // Si no es admin maestro, revisamos si tiene el rol en la DB
                    const snap = await getDoc(doc(db, "colaboradores", user.uid));
                    if (snap.exists() && (snap.data().rol === 'admin' || snap.data().rol === 'staff')) {
                        loading.style.display = 'none';
                        content.style.display = 'block';
                        cargarDatos();
                    } else {
                        loading.style.display = 'none';
                        error.style.display = 'block';
                    }
                }
            } else {
                window.location.href = "login.html";
            }
        });

        function cargarDatos() {
            // Monitor de Colaboradores en Tiempo Real
            onSnapshot(collection(db, "colaboradores"), (snap) => {
                const listaColab = document.getElementById('lista-colab');
                const listaPagos = document.getElementById('lista-pagos');
                listaColab.innerHTML = "";
                listaPagos.innerHTML = "";

                snap.forEach(d => {
                    const c = d.data();
                    const id = d.id;
                    const rol = c.rol || "colaborador";

                    // Tabla de Colaboradores
                    listaColab.innerHTML += `
                        <tr>
                            <td>${c.nombre || 'N/N'}</td>
                            <td>${c.email}</td>
                            <td><span class="badge ${rol === 'admin' ? 'badge-admin' : 'badge-user'}">${rol}</span></td>
                            <td>
                                <button class="btn-action" onclick="window.cambiarRol('${id}', 'admin')">Hacer Admin</button>
                                <button class="btn-action" style="background:#444; color:#fff;" onclick="window.cambiarRol('${id}', 'colaborador')">Quitar</button>
                            </td>
                        </tr>
                    `;

                    // Tabla de Pagos (solo si tienen datos cargados)
                    if (c.metodoPago) {
                        listaPagos.innerHTML += `
                            <tr>
                                <td><strong>${c.nombre}</strong></td>
                                <td>${c.metodoPago}</td>
                                <td style="color:#00FFFF; font-family:monospace;">${c.datoPago}</td>
                            </tr>
                        `;
                    }
                });
            });
        }

        window.cambiarRol = async (uid, nuevoRol) => {
            if(confirm(`¿Cambiar rol a ${nuevoRol}?`)) {
                await updateDoc(doc(db, "colaboradores", uid), { rol: nuevoRol });
            }
        };
    </script>
</body>
</html>