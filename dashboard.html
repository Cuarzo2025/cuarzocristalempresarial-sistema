<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguridad | Cuarzo Cristal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FFFFFF; --bg: #0A0A0A; --card: #141414; --accent: #4CAF50; --border: #333; }
        body { 
            background: var(--bg); color: var(--primary); font-family: 'Montserrat', sans-serif; 
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; 
        }
        .container { 
            background: var(--card); padding: 40px; border-radius: 16px; width: 100%; 
            max-width: 400px; border: 1px solid var(--border); text-align: center; box-sizing: border-box;
        }
        .badge {
            display: inline-block; background: rgba(76, 175, 80, 0.1); color: var(--accent);
            padding: 5px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 800;
            text-transform: uppercase; margin-bottom: 15px;
        }
        h2 { font-weight: 800; margin: 0; text-transform: uppercase; }
        p { color: #A0A0A0; font-size: 0.9rem; margin: 15px 0 25px 0; }
        input { 
            width: 100%; padding: 14px; margin-bottom: 20px; background: #1e1e1e; 
            border: 1px solid var(--border); border-radius: 8px; color: white; box-sizing: border-box; 
        }
        .btn-main { 
            width: 100%; padding: 16px; background: var(--accent); color: white; 
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer; text-transform: uppercase; 
        }
        #loading-screen { font-weight: 600; color: var(--accent); }
    </style>
</head>
<body>

    <div id="loading-screen">Verificando sesión...</div>

    <div id="change-pass-section" class="container" style="display:none;">
        <div class="badge">Seguridad</div>
        <h2>Actualiza tu acceso</h2>
        <p>Por seguridad, crea una contraseña personal para activar tu cuenta en el sistema.</p>
        <input type="password" id="new-password" placeholder="Nueva Contraseña (mín. 6 caracteres)">
        <button id="btn-change" class="btn-main">Guardar y Activar Panel</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docRef = doc(db, "colaboradores", user.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.requiereCambio === false) {
                        // SI YA CAMBIÓ LA CLAVE, VA DIRECTO AL WORKSPACE
                        window.location.href = "workspace.html";
                    } else {
                        // SI NO, MOSTRAMOS EL FORMULARIO
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('change-pass-section').style.display = 'block';
                    }
                }
            } else { 
                window.location.href = "login.html"; 
            }
        });

        document.getElementById('btn-change').addEventListener('click', async () => {
            const newPass = document.getElementById('new-password').value;
            const btn = document.getElementById('btn-change');
            
            if(newPass.length < 6) return alert("Mínimo 6 caracteres");

            btn.innerText = "PROCESANDO...";
            btn.disabled = true;

            try {
                await updatePassword(auth.currentUser, newPass);
                await updateDoc(doc(db, "colaboradores", auth.currentUser.uid), { requiereCambio: false });
                alert("¡Contraseña actualizada! Bienvenido.");
                window.location.href = "workspace.html";
            } catch (error) {
                alert("Por seguridad, debes cerrar sesión e ingresar nuevamente para cambiar la clave.");
                btn.innerText = "Guardar y Activar Panel";
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>