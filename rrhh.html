<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RRHH | Cuarzo Cristal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root { 
            --primary: #FFFFFF; 
            --bg: #000000; 
            --card-main: #0a0a0a; 
            --card-sub: #111111;
            --border: #222222; 
            --text-dim: #777777;
        }
        
        body { 
            margin: 0; padding: 0; width: 100vw; min-height: 100vh; 
            background: var(--bg); font-family: 'Montserrat', sans-serif; color: white;
            display: flex; justify-content: center; padding: 40px 0;
        }

        .container { 
            background: var(--card-main); border: 1px solid var(--border);
            border-radius: 16px; width: 90%; max-width: 850px; padding: 40px;
            box-shadow: 0 10px 50px rgba(0,0,0,1);
        }

        .user-welcome { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 3px; margin-bottom: 10px; font-weight: 600; }
        h1 { font-weight: 800; letter-spacing: -1px; display: flex; align-items: center; gap: 15px; font-size: 1.8rem; margin: 0; text-transform: uppercase; }
        .subtitle { color: var(--text-dim); font-size: 0.8rem; margin-top: 10px; margin-bottom: 35px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }

        /* Dashboard de Días */
        .stats-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-box { background: var(--card-sub); border: 1px solid var(--border); padding: 25px; border-radius: 12px; text-align: center; }
        .stat-box p { font-size: 0.65rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        .stat-box span { font-size: 2.8rem; font-weight: 800; display: block; margin-top: 5px; color: var(--primary); }

        /* Formulario de Solicitud */
        .form-section { background: var(--card-sub); border: 1px solid var(--border); padding: 30px; border-radius: 12px; margin-bottom: 40px; }
        .form-section h2 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 25px; }
        label { display: block; font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; letter-spacing: 1px; }
        
        input, select, textarea { 
            width: 100%; background: #000; border: 1px solid var(--border); 
            padding: 14px; color: white; border-radius: 6px; font-family: inherit; margin-bottom: 20px; box-sizing: border-box; font-size: 0.9rem;
            color-scheme: dark;
        }

        .btn-main { 
            width: 100%; padding: 18px; background: var(--primary); color: #000; border: none; 
            border-radius: 6px; font-weight: 800; text-transform: uppercase; cursor: pointer; letter-spacing: 2px; transition: 0.3s;
        }
        .btn-main:hover { background: #ccc; }

        /* TABLA DE HISTORIAL - CUADRO SINCRONIZADO */
        .history-card { background: var(--card-sub); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .history-header { padding: 20px; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 2px; font-weight: 800; color: var(--text-dim); }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { text-align: left; padding: 15px 20px; background: #050505; color: var(--text-dim); text-transform: uppercase; font-size: 0.6rem; letter-spacing: 1px; }
        td { padding: 15px 20px; border-bottom: 1px solid var(--border); color: #eee; }
        tr:last-child td { border-bottom: none; }

        .status-pill { font-size: 0.6rem; font-weight: 800; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; }
        .PENDIENTE { background: #222; color: #777; border: 1px solid #333; }
        .APROBADO { background: #FFFFFF; color: #000000; }
        .RECHAZADO { background: #440000; color: #FF5555; }

        .back-btn { display: block; text-align: center; margin-top: 40px; color: var(--text-dim); text-decoration: none; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="greeting" class="user-welcome">Sincronizando perfil...</div>
        <h1><i class="fas fa-plane-departure"></i> Human Resources</h1>
        <p class="subtitle">Gestión integral de licencias y solicitudes horarias.</p>

        <div class="stats-container">
            <div class="stat-box">
                <p>Días Habilitados</p>
                <span id="dias-disponibles">--</span>
            </div>
            <div class="stat-box">
                <p>Días Consumidos</p>
                <span id="dias-usados" style="color: #444;">--</span>
            </div>
        </div>

        <div class="form-section">
            <h2>Crear nueva solicitud</h2>
            <form id="request-form">
                <label>Tipo de Gestión</label>
                <select id="tipo-ausencia" required>
                    <option value="Vacaciones Anuales">VACACIONES ANUALES</option>
                    <option value="Licencia Médica">LICENCIA MÉDICA</option>
                    <option value="Día Personal">DÍA PERSONAL / EXAMEN</option>
                </select>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label>Desde (Fecha y Hora)</label>
                        <input type="datetime-local" id="fecha-inicio" required>
                    </div>
                    <div>
                        <label>Hasta (Fecha y Hora)</label>
                        <input type="datetime-local" id="fecha-fin" required>
                    </div>
                </div>

                <label>Notas Adicionales</label>
                <textarea id="motivo" rows="2" placeholder="Opcional..."></textarea>

                <button type="submit" id="btn-enviar" class="btn-main">Enviar Solicitud</button>
            </form>
        </div>

        <div class="history-card">
            <div class="history-header">Historial de Solicitudes</div>
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Desde / Hasta</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    </tbody>
            </table>
        </div>

        <a href="dashboard.html" class="back-btn"><i class="fas fa-chevron-left"></i> Volver al panel</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        emailjs.init("Hh5cKcCjZpu9toPYN");

        let userData = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "colaboradores", user.uid));
                if (snap.exists()) {
                    userData = snap.data();
                    const saludo = userData.genero === "femenino" ? "BIENVENIDA" : "BIENVENIDO";
                    document.getElementById('greeting').innerText = `${saludo}, ${userData.nombre.toUpperCase()}`;
                    document.getElementById('dias-disponibles').innerText = userData.dias_vacaciones_disponibles || "0";
                    document.getElementById('dias-usados').innerText = userData.dias_vacaciones_usados || "0";
                    loadHistory(user.uid);
                }
            } else { window.location.href = "login.html"; }
        });

        async function loadHistory(uid) {
            const q = query(collection(db, "colaboradores", uid, "solicitudes_rrhh"), orderBy("fechaCreacion", "desc"));
            const querySnapshot = await getDocs(q);
            const body = document.getElementById('history-body');
            body.innerHTML = "";

            querySnapshot.forEach((doc) => {
                const item = doc.data();
                const row = `<tr>
                    <td><div style="font-weight:600">${item.tipo}</div><div style="font-size:0.6rem;color:#555">${new Date(item.fechaCreacion.seconds*1000).toLocaleDateString()}</div></td>
                    <td><div style="font-size:0.7rem">${item.inicio.replace('T',' ')}</div><div style="font-size:0.7rem">${item.fin.replace('T',' ')}</div></td>
                    <td><span class="status-pill ${item.estado}">${item.estado}</span></td>
                </tr>`;
                body.innerHTML += row;
            });
        }

        document.getElementById('request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-enviar');
            btn.disabled = true;

            const solicitud = {
                tipo: document.getElementById('tipo-ausencia').value,
                inicio: document.getElementById('fecha-inicio').value,
                fin: document.getElementById('fecha-fin').value,
                motivo: document.getElementById('motivo').value,
                estado: "PENDIENTE",
                fechaCreacion: new Date()
            };

            try {
                await addDoc(collection(db, "colaboradores", auth.currentUser.uid, "solicitudes_rrhh"), solicitud);
                await emailjs.send("service_u1a6rwt", "template_rrhh_request", {
                    from_name: userData.nombre,
                    tipo_licencia: solicitud.tipo,
                    fecha_inicio: solicitud.inicio,
                    fecha_fin: solicitud.fin,
                    motivo: solicitud.motivo,
                    colaborador_email: auth.currentUser.email
                });
                alert("SOLICITUD REGISTRADA EXITOSAMENTE");
                window.location.reload();
            } catch (error) {
                alert("ERROR AL PROCESAR SOLICITUD");
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>