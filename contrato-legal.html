<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrato Legal | Cuarzo Cristal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --bg: #000; --card: #0d0d0d; --border: #333; --text: #fff; --gray: #888; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 40px auto; background-color: var(--card); padding: 40px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .header h1 { font-size: 1.5em; margin: 0; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; gap: 15px; }
        .contract-section { background-color: #111; padding: 30px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #222; }
        h2 { font-size: 0.9em; color: var(--gray); text-transform: uppercase; margin-bottom: 20px; letter-spacing: 1px; }
        .pdf-button { padding: 18px; background-color: #f5f5f5; color: #000; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; width: 100%; text-align: center; text-decoration: none; display: block; margin-bottom: 10px; text-transform: uppercase; }
        .btn-firmar { padding: 18px; background-color: #fff; color: #000; border: none; border-radius: 6px; font-weight: 800; cursor: pointer; width: 100%; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .btn-firmar:disabled { background-color: #222; color: #555; cursor: not-allowed; }
        .recuadro-firma-datos { background-color: #000; padding: 30px; border-radius: 6px; margin-top: 20px; font-family: 'Courier New', monospace; color: #00FF00; border: 1px solid #333; display: none; line-height: 1.6; font-size: 0.85em; }
        .checkbox-container { display: flex; align-items: center; cursor: pointer; padding: 15px; background: #050505; border-radius: 6px; margin-bottom: 20px; border: 1px solid #1a1a1a; }
        input[type="checkbox"] { width: 22px; height: 22px; margin-right: 15px; accent-color: #fff; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-contract"></i> Legales <i class="fas fa-gavel" style="font-size: 0.7em; color: #444;"></i></h1>
            <a href="workspace.html" style="color: #888; text-decoration: none; font-size: 0.8em;"><i class="fas fa-arrow-left"></i> VOLVER</a>
        </div>

        <div class="contract-section">
            <h2>1. Revisión de Documento</h2>
            <p style="font-size: 0.9em; color: #ccc;">Colaborador detectado: <b id="empleado-nombre" style="color:#FFF;">Cargando...</b></p>
            <a href="contrato-legal.pdf" id="btnLeerPDF" target="_blank" class="pdf-button" onclick="habilitarCheck()">
                <i class="fas fa-file-pdf"></i> Visualizar Contrato PDF
            </a>
        </div>

        <div class="contract-section">
            <h2>2. Formalización de Firma</h2>
            <div id="controles-firma">
                <label class="checkbox-container">
                    <input type="checkbox" id="checkAcepto" disabled onchange="habilitarBoton()">
                    <span style="font-size: 0.85em;">Confirmo que he leído y acepto los términos legales de Cuarzo Cristal.</span>
                </label>
                <button id="btnFirmarContrato" class="btn-firmar" disabled onclick="procesoFirmaCompleto()">
                    Confirmar Firma Digital
                </button>
            </div>

            <div id="area-exito" style="display:none; text-align: center;">
                <div id="cuadro-informativo" class="recuadro-firma-datos"></div>
                <p style="color: #FFF; font-weight: 600; margin-top: 25px;">
                    <i class="fas fa-check-circle" style="color: #27AE60;"></i> Documento firmado y enviado correctamente.
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const { PDFDocument, StandardFonts } = PDFLib;

        emailjs.init("Hh5cKcCjZpu9toPYN");

        let uId, dUser;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                uId = user.uid;
                try {
                    const snap = await getDoc(doc(db, "colaboradores", uId));
                    if (snap.exists()) {
                        dUser = snap.data();
                        document.getElementById('empleado-nombre').textContent = (dUser.nombre || "Usuario").toUpperCase();
                        if(dUser.contratoAceptado === true) {
                            mostrarResultadoFinal(dUser.fechaFirma, dUser.horaFirma);
                        }
                    }
                } catch (e) { console.error("Error cargando perfil:", e); }
            } else { window.location.href = "login.html"; }
        });

        window.habilitarCheck = () => { document.getElementById('checkAcepto').disabled = false; };
        window.habilitarBoton = () => { document.getElementById('btnFirmarContrato').disabled = !document.getElementById('checkAcepto').checked; };

        window.procesoFirmaCompleto = async () => {
            const btn = document.getElementById('btnFirmarContrato');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ENVIANDO...';
            btn.disabled = true;

            const ahora = new Date();
            const fecha = ahora.toLocaleDateString('es-AR');
            const hora = ahora.toLocaleTimeString('es-AR');
            const transaccion = uId.substring(0, 10).toUpperCase();

            try {
                const params = {
                    email_usuario: auth.currentUser.email,
                    nombre_usuario: (dUser.nombre || "Colaborador").toUpperCase(),
                    fecha: fecha,
                    hora: hora,
                    id_transaccion: transaccion,
                    nro_doc: dUser.numeroDocumento || "S/D"
                };

                // Envío de Email
                try {
                    await emailjs.send("service_u1a6rwt", "template_rp33rwfo", params);
                } catch (errMail) {
                    throw new Error("Fallo EmailJS: " + (errMail.text || "Verifica IDs"));
                }

                // Actualizar Firebase
                try {
                    await updateDoc(doc(db, "colaboradores", uId), {
                        contratoAceptado: true,
                        fechaFirma: fecha,
                        horaFirma: hora,
                        idTransaccion: transaccion
                    });
                } catch (errDb) {
                    throw new Error("Fallo Firebase: Revisa permisos de escritura.");
                }

                await modificarPDF(fecha, hora, transaccion);
                mostrarResultadoFinal(fecha, hora);

            } catch (error) {
                alert("DETALLE DEL ERROR: " + error.message);
                btn.innerHTML = "Confirmar Firma Digital";
                btn.disabled = false;
            }
        };

        async function modificarPDF(f, h, id) {
            try {
                const url = 'contrato-legal.pdf'; 
                const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const pages = pdfDoc.getPages();
                const lastPage = pages[pages.length - 1]; 
                const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                
                lastPage.drawText(`FIRMADO DIGITALMENTE POR: ${dUser.nombre.toUpperCase()}`, { x: 50, y: 80, size: 9, font });
                lastPage.drawText(`FECHA: ${f} ${h} | ID TRANSACCIÓN: ${id}`, { x: 50, y: 65, size: 9, font });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Contrato_Cuarzo_${dUser.nombre.replace(/\s+/g, '_')}.pdf`;
                link.click();
            } catch (e) { console.error("Error PDF:", e); }
        }

        function mostrarResultadoFinal(f, h) {
            document.getElementById('controles-firma').style.display = 'none';
            document.getElementById('btnLeerPDF').style.display = 'none';
            document.getElementById('area-exito').style.display = 'block';
            const cuadro = document.getElementById('cuadro-informativo');
            cuadro.style.display = 'block';
            cuadro.innerHTML = `
                --- CERTIFICADO DE SEGURIDAD ---<br>
                CUARZO CRISTAL EMPRESARIAL SISTEMA<br><br>
                COLABORADOR: ${(dUser ? dUser.nombre : "USUARIO").toUpperCase()}<br>
                REGISTRO: ${f} | ${h}<br>
                ESTADO: FIRMADO Y VERIFICADO
            `;
        }
    </script>
</body>
</html>