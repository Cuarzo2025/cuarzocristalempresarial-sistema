<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrato Legal - Cuarzo Cristal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        body { background-color: #000000; color: #FFFFFF; font-family: 'Montserrat', sans-serif; margin: 0; padding: 30px; }
        .container { max-width: 900px; margin: auto; background-color: #0d0d0d; padding: 30px; border-radius: 10px; box-shadow: 0 0 40px rgba(255, 255, 255, 0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #333333; padding-bottom: 15px; }
        .header h1 { font-size: 1.8em; margin: 0; display: flex; align-items: center; gap: 15px; color: #FFFFFF; }
        .contract-section { background-color: #1a1a1a; padding: 25px; border-radius: 8px; margin-bottom: 20px; }
        
        .pdf-button { padding: 15px 25px; background-color: #A93226; color: #FFFFFF; border: none; border-radius: 5px; font-weight: 800; cursor: pointer; transition: 0.3s; width: 100%; text-align: center; text-decoration: none; display: block; margin-bottom: 20px; }
        .btn-firmar { padding: 15px 25px; background-color: #FFFFFF; color: #000000; border: none; border-radius: 5px; font-weight: 800; cursor: pointer; width: 100%; display: block; transition: 0.3s; text-transform: uppercase; }
        .btn-firmar:disabled { background-color: #111 !important; color: #444 !important; cursor: not-allowed; opacity: 0.5; }

        .recuadro-firma-datos {
            background-color: #000; padding: 25px; border-radius: 5px; margin-top: 15px; 
            font-family: 'Courier New', monospace; color: #FFFFFF; font-weight: bold; border: 1px dashed #FFFFFF;
            display: none; line-height: 1.8; font-size: 0.9em;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-file-alt"></i> Gestión de Contrato</h1>
            <a href="workspace.html" style="color:#ccc; text-decoration:none;"><i class="fas fa-arrow-left"></i> Volver</a>
        </div>

        <div class="contract-section">
            <h2>1. Revisión de Documento</h2>
            <p>Colaborador: <span id="empleado-nombre" style="color:#FFFFFF; font-weight:800; text-decoration: underline;">Cargando...</span></p>
            <a href="contrato-legal.pdf" id="btnLeerPDF" target="_blank" class="pdf-button" onclick="paso1_HabilitarCheck()">
                <i class="fas fa-file-pdf"></i> ABRIR Y LEER CONTRATO PDF
            </a>
        </div>

        <div class="contract-section">
            <h2>2. Aceptación y Firma Final</h2>
            <div id="controles-firma">
                <div style="padding: 15px; border: 1px dashed #333; border-radius: 5px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="checkAcepto" disabled onchange="paso2_HabilitarBoton()" style="width: 22px; height: 22px; margin-right: 15px;">
                        <span>He leído y acepto los términos del contrato (Sedes ARG/URY/MERCOSUR).</span>
                    </label>
                </div>
                <button id="btnFirmarContrato" class="btn-firmar" disabled onclick="paso3_EjecutarFirmaManual()">
                    <i class="fas fa-signature"></i> FIRMAR CONTRATO AHORA
                </button>
            </div>

            <div id="area-exito" style="display:none;">
                <div id="cuadro-informativo" class="recuadro-firma-datos"></div>
                <p style="color: #27AE60; font-weight: 800; margin-top: 20px; text-align: center;">
                    <i class="fas fa-check-double"></i> CONTRATO FIRMADO Y REGISTRADO
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const { PDFDocument, rgb, StandardFonts } = PDFLib;

        emailjs.init("Hh5cKcCjZpu9toPYN"); 

        let uId, dUser;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                uId = user.uid;
                const snap = await getDoc(doc(db, "colaboradores", uId));
                if (snap.exists()) {
                    dUser = snap.data();
                    document.getElementById('empleado-nombre').textContent = (dUser.nombre || "Usuario").toUpperCase();
                    if(dUser.contratoAceptado) mostrarResultadoFinal(dUser.fechaFirma, dUser.horaFirma);
                }
            } else { window.location.href = "login.html"; }
        });

        window.paso1_HabilitarCheck = () => { document.getElementById('checkAcepto').disabled = false; };
        window.paso2_HabilitarBoton = () => { document.getElementById('btnFirmarContrato').disabled = !document.getElementById('checkAcepto').checked; };

        window.paso3_EjecutarFirmaManual = async () => {
            const btn = document.getElementById('btnFirmarContrato');
            btn.disabled = true;

            const ahora = new Date();
            const f = ahora.toLocaleDateString('es-AR');
            const h = ahora.toLocaleTimeString('es-AR');

            try {
                // GUARDAR EN FIREBASE USANDO LOS CAMPOS CORRECTOS
                await updateDoc(doc(db, "colaboradores", uId), {
                    contratoAceptado: true,
                    fechaFirma: f,
                    horaFirma: h,
                    idTransaccion: uId.substring(0, 10).toUpperCase()
                });

                await modificarContratoExistente(f, h);
                await enviarContratoPorEmail(f, h);
                mostrarResultadoFinal(f, h);

            } catch (e) {
                console.error(e);
                alert("Error al procesar la firma.");
                btn.disabled = false;
            }
        };

        async function enviarContratoPorEmail(fecha, hora) {
            // MAPEO CORRECTO CON EL FORMULARIO DE DATOS PERSONALES
            const params = {
                nombre_usuario: dUser.nombre ? dUser.nombre.toUpperCase() : "No registrado",
                email_usuario: auth.currentUser.email,
                nacionalidad: dUser.nacionalidad || "No especificada",
                tipo_doc: (dUser.tipoDocumento || "ID").toUpperCase(),
                nro_doc: dUser.numeroDocumento || "S/N",
                domicilio_profesional: dUser.domicilio || "No registrado",
                pais_profesional: dUser.pais || "No especificado",
                cuil_tax: dUser.cuit || "Pendiente",
                fecha: fecha,
                hora: hora,
                id_transaccion: uId.substring(0, 10).toUpperCase()
            };

            try {
                await emailjs.send("service_xw9imdi", "template_rp33rwfo", params);
            } catch (error) {
                console.error("Error EmailJS:", error);
            }
        }

        async function modificarContratoExistente(fecha, hora) {
            try {
                const url = 'contrato-legal.pdf'; 
                const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const pages = pdfDoc.getPages();
                const lastPage = pages[pages.length - 1]; 
                
                const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                
                // USANDO LAS VARIABLES CORRECTAS DEL FORMULARIO
                const nDoc = dUser.numeroDocumento || "S/N";
                const tDoc = (dUser.tipoDocumento || "ID").toUpperCase();
                const pais = dUser.pais || "No especificado";

                lastPage.drawText(`REPRESENTANTE LEGAL: CUARZO CRISTAL (SEDE REGIONAL)`, { x: 50, y: 100, size: 10, font });
                lastPage.drawText(`IDENTIFICACIÓN: ${tDoc} ${nDoc}`, { x: 50, y: 85, size: 10, font });
                lastPage.drawText(`FIRMADO POR: ${dUser.nombre.toUpperCase()}`, { x: 50, y: 70, size: 10, font });
                lastPage.drawText(`UBICACIÓN: ${pais.toUpperCase()} - ${fecha} ${hora}`, { x: 50, y: 55, size: 10, font });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Contrato_Cuarzo_${dUser.nombre}.pdf`;
                link.click();
            } catch (err) {
                console.error("Error PDF:", err);
            }
        }

        function mostrarResultadoFinal(f, h) {
            document.getElementById('controles-firma').style.display = 'none';
            document.getElementById('btnLeerPDF').style.display = 'none';
            document.getElementById('area-exito').style.display = 'block';
            const cuadro = document.getElementById('cuadro-informativo');
            cuadro.style.display = 'block';
            
            cuadro.innerHTML = `
                --- CERTIFICADO DE FIRMA DIGITAL ---<br>
                EMPRESA: CUARZO CRISTAL EMPRESARIAL<br>
                COLABORADOR: ${dUser.nombre.toUpperCase()}<br>
                PAÍS: ${dUser.pais || 'No especificado'}<br>
                ID TRANSACCIÓN: ${uId.substring(0, 10).toUpperCase()}<br>
                REGISTRO: ${f} | ${h}<br>
                ESTADO: VÁLIDO E INALTERABLE
            `;
        }
    </script>
</body>
</html>