<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legales | Cuarzo Cristal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { 
            --bg: #000000; 
            --card: #0a0a0a; 
            --border: #1a1a1a; 
            --text: #ffffff; 
            --gray: #666666; 
            --accent: #f2f2f2;
        }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 20px; display: flex; justify-content: center; }
        
        .container { 
            width: 100%;
            max-width: 650px; 
            margin: 40px auto; 
            background-color: var(--card); 
            padding: 50px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            box-sizing: border-box;
        }

        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 50px; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 25px; 
        }
        
        .header h1 { font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 4px; margin: 0; }
        .volviendo { color: var(--gray); text-decoration: none; font-size: 0.65rem; font-weight: 600; letter-spacing: 1px; transition: 0.3s; }
        .volviendo:hover { color: #fff; }

        .contract-section { 
            background-color: #050505; 
            padding: 30px; 
            border-radius: 4px; 
            margin-bottom: 25px; 
            border: 1px solid var(--border); 
        }
        
        h2 { font-size: 0.6rem; color: var(--gray); text-transform: uppercase; margin-bottom: 20px; letter-spacing: 2px; border-left: 2px solid #333; padding-left: 15px; }

        .btn-secundario { 
            padding: 15px; 
            background-color: transparent; 
            color: #fff; 
            border: 1px solid #222; 
            border-radius: 4px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            text-align: center; 
            text-decoration: none; 
            display: block; 
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: 0.3s;
            box-sizing: border-box;
        }
        .btn-secundario:hover { border-color: #555; background: #080808; }

        .btn-principal { 
            padding: 20px; 
            background-color: var(--accent); 
            color: #000; 
            border: none; 
            border-radius: 4px; 
            font-weight: 800; 
            cursor: pointer; 
            width: 100%; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            font-size: 0.75rem;
            transition: 0.3s; 
        }
        .btn-principal:hover:not(:disabled) { background-color: #ffffff; transform: translateY(-1px); }
        .btn-principal:disabled { background-color: #151515; color: #444; cursor: not-allowed; }

        .recuadro-hash { 
            background-color: #000; 
            padding: 25px; 
            border-radius: 4px; 
            margin-top: 25px; 
            font-family: 'Courier New', monospace; 
            color: #555; 
            border: 1px solid var(--border); 
            display: none; 
            line-height: 1.8; 
            font-size: 0.7rem; 
            text-align: left;
        }

        .checkbox-wrapper { 
            display: flex; 
            align-items: center; 
            cursor: pointer; 
            padding: 20px; 
            background: #000; 
            border-radius: 4px; 
            margin-bottom: 25px; 
            border: 1px solid var(--border); 
            font-size: 0.7rem;
            color: #888;
            line-height: 1.4;
        }
        input[type="checkbox"] { width: 18px; height: 18px; margin-right: 15px; accent-color: #fff; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Legal Department</h1>
            <a href="workspace.html" class="volviendo">BACK</a>
        </div>

        <div class="contract-section">
            <h2>01. Review Document</h2>
            <p style="font-size: 0.75rem; color: #555; margin-bottom: 20px; letter-spacing: 0.5px;">
                Colaborador: <b id="empleado-nombre" style="color:#eee;">Checking...</b>
            </p>
            <a href="contrato-legal.pdf" id="btnLeerPDF" target="_blank" class="btn-secundario" onclick="habilitarCheck()">
                Open Contract PDF
            </a>
        </div>

        <div class="contract-section">
            <h2>02. Digital Signature</h2>
            <div id="controles-firma">
                <label class="checkbox-wrapper">
                    <input type="checkbox" id="checkAcepto" disabled onchange="habilitarBoton()">
                    <span>I confirm that I have read and accepted the legal terms and conditions of Cuarzo Cristal.</span>
                </label>
                <button id="btnFirmarContrato" class="btn-principal" disabled onclick="ejecutarFirma()">
                    Sign Document
                </button>
            </div>

            <div id="area-exito" style="display:none; text-align: center;">
                <div id="cuadro-informativo" class="recuadro-hash"></div>
                <p style="color: #fff; font-size: 0.65rem; font-weight: 800; margin-top: 30px; letter-spacing: 2px;">
                    <i class="fas fa-shield-alt" style="margin-right: 10px;"></i> TRANSACTION VERIFIED
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCW3_c7c4wNs6mUgX0EFp40SnjBx-WfLNI",
            authDomain: "cuarzocristalempresarialsist.firebaseapp.com",
            projectId: "cuarzocristalempresarialsist",
            storageBucket: "cuarzocristalempresarialsist.firebasestorage.app",
            messagingSenderId: "1031610061736",
            appId: "1:1031610061736:web:d05d431b433eb5b55ec39d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const { PDFDocument, StandardFonts } = PDFLib;

        emailjs.init("Hh5cKcCjZpu9toPYN");

        let uId, dUser;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                uId = user.uid;
                const snap = await getDoc(doc(db, "colaboradores", uId));
                if (snap.exists()) {
                    dUser = snap.data();
                    document.getElementById('empleado-nombre').textContent = (dUser.nombre || "User").toUpperCase();
                    if(dUser.contratoAceptado === true) {
                        mostrarResultadoFinal(dUser.fechaFirma, dUser.horaFirma, dUser.idTransaccion);
                    }
                }
            } else { window.location.href = "login.html"; }
        });

        window.habilitarCheck = () => { document.getElementById('checkAcepto').disabled = false; };
        window.habilitarBoton = () => { document.getElementById('btnFirmarContrato').disabled = !document.getElementById('checkAcepto').checked; };

        window.ejecutarFirma = async () => {
            const btn = document.getElementById('btnFirmarContrato');
            btn.innerHTML = 'ENCRYPTING...';
            btn.disabled = true;

            const ahora = new Date();
            const fecha = ahora.toLocaleDateString('es-AR');
            const hora = ahora.toLocaleTimeString('es-AR');
            const transaccion = uId.substring(0, 8).toUpperCase() + Math.floor(Math.random() * 1000);

            // Mapeo completo de datos para el template largo
            const templateParams = {
                nombre_usuario: (dUser.nombre || "Sin Nombre").toUpperCase(),
                email_usuario: auth.currentUser.email,
                nacionalidad: (dUser.nacionalidad || "S/D").toUpperCase(),
                tipo_doc: (dUser.tipoIdentificacion || "DNI/CI"),
                nro_doc: dUser.numeroDocumento || "S/D",
                domicilio_profesional: (dUser.direccion || "Domicilio Registrado").toUpperCase(),
                pais_profesional: (dUser.pais || "S/D").toUpperCase(),
                cuil_tax: dUser.cuil || dUser.identificacionFiscal || "S/D",
                fecha: fecha,
                hora: hora,
                id_transaccion: transaccion
            };

            try {
                // 1. Enviar Mail (Template verificado: template_rp3rwfo)
                await emailjs.send("service_u1a6rwt", "template_rp3rwfo", templateParams);

                // 2. Guardar en Firebase
                await updateDoc(doc(db, "colaboradores", uId), {
                    contratoAceptado: true,
                    fechaFirma: fecha,
                    horaFirma: hora,
                    idTransaccion: transaccion
                });

                // 3. Generar PDF Firmado
                await generarPDF(fecha, hora, transaccion);
                
                // 4. Interfaz de Ã‰xito
                mostrarResultadoFinal(fecha, hora, transaccion);

            } catch (error) {
                console.error("Error en el proceso:", error);
                alert("Error: No se pudo completar la firma. " + error.message);
                btn.innerHTML = "RETRY SIGNATURE";
                btn.disabled = false;
            }
        };

        async function generarPDF(f, h, id) {
            try {
                const url = 'contrato-legal.pdf'; 
                const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());
                const pdfDoc = await PDFDocument.load(existingPdfBytes);
                const pages = pdfDoc.getPages();
                const lastPage = pages[pages.length - 1]; 
                const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
                
                lastPage.drawText(`FIRMADO DIGITALMENTE POR: ${dUser.nombre.toUpperCase()}`, { x: 50, y: 45, size: 7, font });
                lastPage.drawText(`HASH ID: ${id} | REGISTRO: ${f} ${h}`, { x: 50, y: 35, size: 6, font });

                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: "application/pdf" });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `CONTRATO_FIRMADO_CUARZO.pdf`;
                link.click();
            } catch (e) { console.error("PDF Fail:", e); }
        }

        function mostrarResultadoFinal(f, h, id) {
            document.getElementById('controles-firma').style.display = 'none';
            document.getElementById('btnLeerPDF').style.display = 'none';
            document.getElementById('area-exito').style.display = 'block';
            const cuadro = document.getElementById('cuadro-informativo');
            cuadro.style.display = 'block';
            cuadro.innerHTML = `
                - CERTIFICATE OF DIGITAL AUTHENTICITY -<br>
                ---------------------------------------<br>
                ENTITY: CUARZO CRISTAL EMPRESARIAL<br>
                OWNER: ${(dUser ? dUser.nombre : "---").toUpperCase()}<br>
                ID: ${(dUser ? dUser.tipoIdentificacion : "DOC")} ${(dUser ? dUser.numeroDocumento : "---")}<br>
                DATE: ${f} | TIME: ${h}<br>
                HASH: ${id}<br>
                STATUS: ENCRYPTED & SIGNED
            `;
        }
    </script>
</body>
</html>